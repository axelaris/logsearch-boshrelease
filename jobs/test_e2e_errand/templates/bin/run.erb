#!/bin/bash

set -e
set -u
set -x

function fail {
  echo "FAILURE: ${1}" >&2
  
  exit 1
}

cd /var/vcap/jobs/test_e2e_errand

export PATH="/var/vcap/packages/java8/bin:$PATH"

[ ! -e /home/vcap/.sincedb ] || rm /home/vcap/.sincedb

export QUERY=$(cat <<EOF
{ "query": {
    "filtered" : {
        "query" : {
            "term" : { "@source.host":"sample-logs--repo-commits" }
        },
        "filter" : {
          "bool" : {
            "must" : {
                "range" : {
                    "@timestamp" : {
                        "from" : "$(date --iso-8601=ns)",
                        "to" : "now"
                    }
                }
            }
          }
        }
     }
  }
}
EOF
)

echo '' ; echo '==> Installing syslog output plugin...'

/var/vcap/packages/logstash/logstash/bin/plugin install logstash-output-syslog

echo '' ; echo '==> Shipping test data...'

/var/vcap/packages/logstash/logstash/bin/logstash --config config/repo-commits.conf

echo '' ; echo '==> Waiting for shipped logs to be ingested and indexed...'

n=0
until [ $n -ge 5 ]
do
  curl -s -d "$QUERY" -X POST '<%= p('test_e2e_errand.elasticsearch_hostport') %>/_count' > curl.out
  cat curl.out
  grep '"count":32' curl.out && break  
  echo "30 shipped logs not detected yet.  Waiting 15 seconds then trying again..."
  n=$[$n+1]
  sleep 15
done

echo '' ; echo '==> Refreshing indices...'

curl -s -X POST '<%= p('test_e2e_errand.elasticsearch_hostport') %>/_refresh' ; echo ''

echo '' ; echo '==> Dumping test data...'

curl -s -d "$QUERY" -X POST '<%= p('test_e2e_errand.elasticsearch_hostport') %>/_search?size=1024&pretty' > curl.out

echo '' ; echo '==> Validating results...'

if ! grep '"total" : 32' curl.out > /dev/null 2>&1 ; then
  cat curl.out
  fail 'Failed to capture expected number of messages'
fi

TESTLINE=$( grep '9d666a0da317777d35e763800ddfd8507cfb580c b056061ab74cc30ee2e6ea3e530f7262b2245228 2015-05-28 18:36:28 -0600 Danny Berger // Start experimenting with concourse' curl.out )

if ! echo "${TESTLINE}" | grep '"commit":"9d666a0da317777d35e763800ddfd8507cfb580c"' > /dev/null 2>&1 ; then
  fail 'Failed to capture commit field'
elif ! echo "${TESTLINE}" | grep '"parents":\["b056061ab74cc30ee2e6ea3e530f7262b2245228"\]' > /dev/null 2>&1 ; then
  fail 'Failed to capture parent field'
fi

echo '' ; echo "SUCCESS"
